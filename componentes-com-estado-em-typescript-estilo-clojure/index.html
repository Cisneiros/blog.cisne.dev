<!DOCTYPE html><html lang="pt-BR" class=" "><head><meta name="generator" content="React Static"/><title data-react-helmet="true">Componentes com estado em Type­Script, estilo Clojure · Cisne.dev blog</title><meta charSet="UTF-8"/><meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=5, shrink-to-fit=no"/><meta data-react-helmet="true" property="og:type" content="article"/><meta data-react-helmet="true" name="twitter:card" content="summary_large_image"/><meta data-react-helmet="true" name="twitter:creator" content="Cisneiros"/><meta data-react-helmet="true" property="og:title" content="Componentes com estado em Type­Script, estilo Clojure · Cisne.dev blog"/><meta data-react-helmet="true" property="og:image" content="https://blog.cisne.dev/componentes-com-estado-em-typescript-estilo-clojure/social-image.png"/><meta data-react-helmet="true" name="twitter:title" content="Componentes com estado em Type­Script, estilo Clojure · Cisne.dev blog"/><meta data-react-helmet="true" name="twitter:image" content="https://blog.cisne.dev/componentes-com-estado-em-typescript-estilo-clojure/social-image.png"/><link rel="preload" as="script" href="/templates/vendors~__react_static_root__/src/containers/post~__react_static_root__/src/containers/postList.207edc50.js"/><link rel="preload" as="script" href="/templates/__react_static_root__/src/containers/post~__react_static_root__/src/containers/postList.a04ea84b.js"/><link rel="preload" as="script" href="/templates/__react_static_root__/src/containers/post.d8dd52db.js"/><link rel="preload" as="script" href="/templates/vendors~main.272ae1d1.js"/><link rel="preload" as="script" href="/main.f19d4c14.js"/><link data-react-helmet="true" rel="stylesheet" href="//unpkg.com/dracula-prism/dist/css/dracula-prism.min.css"/><style data-styled="" data-styled-version="5.1.1">.CfxHf{max-width:960px;margin:0 auto;position:relative;}/*!sc*/
data-styled.g1[id="ui__Fit-prwz6b-0"]{content:"CfxHf,"}/*!sc*/
.iuDFSN{padding:1rem;color:var(--color-mid);text-align:center;font-size:1.5rem;}/*!sc*/
.iuDFSN a,.iuDFSN a:hover{-webkit-text-decoration:none;text-decoration:none;color:inherit;}/*!sc*/
data-styled.g2[id="Navigation__Container-sc-1yk0pqp-0"]{content:"iuDFSN,"}/*!sc*/
.izuwCZ{max-width:960px;margin:0 auto;position:relative;display:-webkit-box;display:-webkit-flex;display:-ms-flexbox;display:flex;-webkit-box-pack:justify;-webkit-justify-content:space-between;-ms-flex-pack:justify;justify-content:space-between;}/*!sc*/
data-styled.g3[id="Navigation__NavFit-sc-1yk0pqp-1"]{content:"izuwCZ,"}/*!sc*/
.TctaC{width:2.5rem;height:1.2em;overflow:hidden;--default-rotation:-180deg;}/*!sc*/
@media (prefers-color-scheme:dark){.TctaC{--default-rotation:0;}}/*!sc*/
data-styled.g4[id="Navigation__BrightnessContainer-sc-1yk0pqp-2"]{content:"TctaC,"}/*!sc*/
.sLeDt{-webkit-transform:rotate(var(--default-rotation));-ms-transform:rotate(var(--default-rotation));transform:rotate(var(--default-rotation));-webkit-transition:-webkit-transform 0.3s ease-out;-webkit-transition:transform 0.3s ease-out;transition:transform 0.3s ease-out;}/*!sc*/
html.light .sLeDt{-webkit-transform:rotate(-180deg);-ms-transform:rotate(-180deg);transform:rotate(-180deg);}/*!sc*/
html.dark .sLeDt{-webkit-transform:rotate(0);-ms-transform:rotate(0);transform:rotate(0);}/*!sc*/
data-styled.g5[id="Navigation__BrightnessSpinner-sc-1yk0pqp-3"]{content:"sLeDt,"}/*!sc*/
.frsARl{background:none;border:none;cursor:pointer;}/*!sc*/
.frsARl:last-child{-webkit-transform:rotate(180deg);-ms-transform:rotate(180deg);transform:rotate(180deg);}/*!sc*/
data-styled.g7[id="Navigation__BrightnessIcon-sc-1yk0pqp-5"]{content:"frsARl,"}/*!sc*/
.gdHjSq{margin-top:3rem;padding:1rem;background:var(--color-foreground);color:var(--color-background);}/*!sc*/
.gdHjSq a{color:var(--text-inverse-color-1);}/*!sc*/
.gdHjSq a:hover{color:var(--text-inverse-color-3);}/*!sc*/
data-styled.g8[id="Footer__Container-b3q04c-0"]{content:"gdHjSq,"}/*!sc*/
.layJcq{max-width:960px;margin:0 auto;position:relative;display:-webkit-box;display:-webkit-flex;display:-ms-flexbox;display:flex;-webkit-box-pack:justify;-webkit-justify-content:space-between;-ms-flex-pack:justify;justify-content:space-between;}/*!sc*/
data-styled.g9[id="Footer__FooterFit-b3q04c-1"]{content:"layJcq,"}/*!sc*/
*{box-sizing:border-box;margin:0;padding:0;border:0;font-size:inherit;font-weight:inherit;font-style:inherit;}/*!sc*/
:root{--color-1:#12c2e9;--color-2:#c471ed;--color-3:#f64f59;--color-1-darker:#0A7B94;--color-2-darker:#AE3CE7;--color-3-darker:#E90C1B;--color-light:#fefefe;--color-dark:#030303;--color-mid-dark:#747481;--color-mid-light:#818181;--font-weight-light:300;--font-weight-regular:400;--font-weight-heavy:500;--font-family-light:"HelveticaNeue-Light","Helvetica Neue Light",'Helvetica Neue',sans-serif;--font-family:'Helvetica Neue',sans-serif;}/*!sc*/
strong,h1,h2,h3,h4,h5,h6{font-family:var(--font-family);}/*!sc*/
html{font-family:var(--font-family-light);font-size:20px;line-height:1;color:var(--color-foreground);background-color:var(--color-background);text-rendering:optimizeLegibility;}/*!sc*/
@media (max-width:600px){html{font-size:16px;}}/*!sc*/
html,html.light{--color-background:var(--color-light);--color-foreground:var(--color-dark);--color-mid:var(--color-mid-dark);--text-color-1:var(--color-1-darker);--text-color-2:var(--color-2-darker);--text-color-3:var(--color-3-darker);--text-inverse-color-1:var(--color-1);--text-inverse-color-2:var(--color-2);--text-inverse-color-3:var(--color-3);}/*!sc*/
html.dark{--color-background:var(--color-dark);--color-foreground:var(--color-light);--color-mid:var(--color-mid-light);--text-color-1:var(--color-1);--text-color-2:var(--color-2);--text-color-3:var(--color-3);--text-inverse-color-1:var(--color-1-darker);--text-inverse-color-2:var(--color-2-darker);--text-inverse-color-3:var(--color-3-darker);}/*!sc*/
@media (prefers-color-scheme:dark){html{--color-background:var(--color-dark);--color-foreground:var(--color-light);--color-mid:var(--color-mid-light);}}/*!sc*/
body{font-size:1em;font-weight:var(--font-weight-light);}/*!sc*/
strong{font-weight:var(--font-weight-heavy);}/*!sc*/
em{font-style:italic;}/*!sc*/
main{padding:1rem;}/*!sc*/
hr{width:30%;margin:4rem auto;border:none;border-bottom:dotted 1px var(--color-1);}/*!sc*/
.pagination{text-align:center;}/*!sc*/
.pagination a{color:var(--text-color-1);}/*!sc*/
.pagination a:hover{color:var(--text-color-3);}/*!sc*/
a{color:var(--text-color-1);-webkit-text-decoration-color:#c471ed80;text-decoration-color:#c471ed80;-webkit-text-decoration-style:wavy;text-decoration-style:wavy;}/*!sc*/
a:hover{color:var(--text-color-3);-webkit-text-decoration-color:#12c2e980;text-decoration-color:#12c2e980;}/*!sc*/
.phone-mockup{max-width:15rem;margin:0 auto 1rem;position:relative;}/*!sc*/
.phone-mockup::before{content:'';width:100%;height:100%;position:absolute;pointer-events:none;background:url(/iphone-11-pro.png) no-repeat;background-size:contain;}/*!sc*/
.phone-mockup video,.phone-mockup img{width:100%;padding:9.3%;}/*!sc*/
data-styled.g14[id="sc-global-hFBrmQ1"]{content:"sc-global-hFBrmQ1,"}/*!sc*/
.tuaWG{display:-webkit-box;display:-webkit-flex;display:-ms-flexbox;display:flex;-webkit-box-pack:justify;-webkit-justify-content:space-between;-ms-flex-pack:justify;justify-content:space-between;}/*!sc*/
@media (max-width:600px){.tuaWG{-webkit-flex-direction:column;-ms-flex-direction:column;flex-direction:column;}}/*!sc*/
data-styled.g23[id="Poststyles__AfterPost-sc-12qb97v-0"]{content:"tuaWG,"}/*!sc*/
.gkeqUt{-webkit-flex:1;-ms-flex:1;flex:1;}/*!sc*/
@media (max-width:600px){.gkeqUt{text-align:center;margin-bottom:1rem;}}/*!sc*/
data-styled.g24[id="Poststyles__AfterPostChild-sc-12qb97v-1"]{content:"gkeqUt,"}/*!sc*/
.fAvgXR{-webkit-flex:1;-ms-flex:1;flex:1;text-align:right;-webkit-hyphens:none;-moz-hyphens:none;-ms-hyphens:none;-webkit-hyphens:none;-moz-hyphens:none;-ms-hyphens:none;hyphens:none;}/*!sc*/
@media (max-width:600px){.fAvgXR{text-align:center;margin-bottom:1rem;}}/*!sc*/
data-styled.g25[id="Poststyles__Tags-sc-12qb97v-2"]{content:"fAvgXR,"}/*!sc*/
.kSZCZX::before{content:' #';color:var(--color-mid);}/*!sc*/
data-styled.g26[id="Poststyles__Tag-sc-12qb97v-3"]{content:"kSZCZX,"}/*!sc*/
.kyWzPB{-webkit-hyphens:auto;-moz-hyphens:auto;-ms-hyphens:auto;-webkit-hyphens:auto;-moz-hyphens:auto;-ms-hyphens:auto;hyphens:auto;}/*!sc*/
data-styled.g27[id="Poststyles__Container-sc-12qb97v-4"]{content:"kyWzPB,"}/*!sc*/
.hhBwVH{font-size:5rem;font-weight:var(--font-weight-regular);line-height:0.8;background:linear-gradient(var(--color-1),var(--color-2),var(--color-3));-webkit-text-fill-color:transparent;background-clip:text;-webkit-background-clip:text;padding-bottom:1rem;margin:1rem 0;}/*!sc*/
html.rainbow .hhBwVH{background-image:linear-gradient(124deg,#ff2400,#e81d1d,#e8b71d,#e3e81d,#1de840,#1ddde8,#2b1de8,#dd00f3,#dd00f3);-webkit-animation:hTUzwZ 9s ease infinite;animation:hTUzwZ 9s ease infinite;background-size:450% 450%;}/*!sc*/
@media (max-width:600px){.hhBwVH{font-size:3.5rem;}}/*!sc*/
.hhBwVH a{-webkit-text-decoration:none;text-decoration:none;}/*!sc*/
data-styled.g28[id="Poststyles__Title-sc-12qb97v-5"]{content:"hhBwVH,"}/*!sc*/
.fonWHZ{color:var(--color-mid);text-align:center;margin-bottom:2rem;}/*!sc*/
data-styled.g29[id="Poststyles__Meta-sc-12qb97v-6"]{content:"fonWHZ,"}/*!sc*/
.jhgzPU{line-height:1.6;}/*!sc*/
.jhgzPU h2{font-size:2.5rem;}/*!sc*/
.jhgzPU h3{font-size:2rem;}/*!sc*/
.jhgzPU h4{font-size:1.5rem;}/*!sc*/
.jhgzPU h2,.jhgzPU h3,.jhgzPU h4,.jhgzPU h5,.jhgzPU h6{-webkit-hyphens:auto;-moz-hyphens:auto;-ms-hyphens:auto;hyphens:auto;font-weight:var(--font-weight-regular);line-height:0.8;padding-bottom:1rem;margin-top:2rem;}/*!sc*/
.jhgzPU img{max-width:100%;}/*!sc*/
.jhgzPU pre.refractor{margin-top:0;margin-left:0;padding-left:1rem;border-left:solid 0.25rem var(--color-1);border-radius:0;font-size:0.8rem;overflow-wrap:normal;overflow-x:auto;background-color:var(--color-dark);color:var(--color-light);padding-top:0.5rem;padding-bottom:0.5rem;-webkit-hyphens:none;-moz-hyphens:none;-ms-hyphens:none;-webkit-hyphens:none;-moz-hyphens:none;-ms-hyphens:none;hyphens:none;}/*!sc*/
.jhgzPU pre.refractor::-webkit-scrollbar{width:0.25rem;height:0.25rem;}/*!sc*/
.jhgzPU pre.refractor code,.jhgzPU code{font-family:'Fira Code','Menlo',monospace;}/*!sc*/
.jhgzPU p code{color:var(--text-color-3);}/*!sc*/
.jhgzPU p code,.jhgzPU h1 code,.jhgzPU h2 code,.jhgzPU h3 code,.jhgzPU h4 code,.jhgzPU h5 code,.jhgzPU h6 code{font-size:0.9em;}/*!sc*/
.jhgzPU p,.jhgzPU pre,.jhgzPU ul,.jhgzPU ol,.jhgzPU table,.jhgzPU blockquote,.jhgzPU .live-code-container{margin-bottom:1rem;}/*!sc*/
.jhgzPU twitter-widget{margin-bottom:1rem !important;}/*!sc*/
.jhgzPU p:last-child,.jhgzPU pre:last-child,.jhgzPU ul:last-child,.jhgzPU ol:last-child,.jhgzPU table:last-child,.jhgzPU blockquote:last-child,.jhgzPU .live-code-container:last-child{margin-bottom:0;}/*!sc*/
.jhgzPU ul,.jhgzPU ol{list-style:none;margin-left:1rem;counter-reset:li;}/*!sc*/
.jhgzPU li{counter-increment:li;display:-webkit-box;display:-webkit-flex;display:-ms-flexbox;display:flex;}/*!sc*/
.jhgzPU ul li::before{content:'•';margin-right:0.5rem;color:var(--color-2);}/*!sc*/
.jhgzPU ol li::before{content:"."counter(li);margin-right:0.5rem;color:var(--color-2);font-weight:var(--font-weight-regular);width:1em;display:inline-block;margin-left:-0.5em;margin-right:0.5em;text-align:right;direction:rtl;}/*!sc*/
.jhgzPU table{margin-left:auto;margin-right:auto;border-spacing:0;font-size:0.9em;}/*!sc*/
.jhgzPU td,.jhgzPU th{border-bottom:solid 1px var(--color-2);padding:0.5rem;}/*!sc*/
.jhgzPU th{font-weight:var(--font-weight-heavy);}/*!sc*/
.jhgzPU tr:hover{background:var(--color-2);}/*!sc*/
.jhgzPU tr:last-of-type td{border-bottom:0;}/*!sc*/
.jhgzPU blockquote{padding-left:1rem;border-left:solid 0.25rem var(--color-3);color:var(--color-mid);}/*!sc*/
data-styled.g30[id="Poststyles__Content-sc-12qb97v-7"]{content:"jhgzPU,"}/*!sc*/
.jjKdZc{position:fixed;top:0;left:0;right:0;height:0.25rem;background-color:var(--color-1);-webkit-transition:opacity 0.25s ease-out;transition:opacity 0.25s ease-out;z-index:2;}/*!sc*/
data-styled.g31[id="post__ScrollTrackerContainer-gh0jqu-0"]{content:"jjKdZc,"}/*!sc*/
@-webkit-keyframes hTUzwZ{0%{background-position:0% 82%;}50%{background-position:100% 19%;}100%{background-position:0% 82%;}}/*!sc*/
@keyframes hTUzwZ{0%{background-position:0% 82%;}50%{background-position:100% 19%;}100%{background-position:0% 82%;}}/*!sc*/
data-styled.g32[id="sc-keyframes-hTUzwZ"]{content:"hTUzwZ,"}/*!sc*/
</style><link rel="alternate" type="application/rss+xml" title="RSS Feed" href="/feed.xml"/></head><body><div id="root"><nav class="Navigation__Container-sc-1yk0pqp-0 iuDFSN"><div class="ui__Fit-prwz6b-0 Navigation__NavFit-sc-1yk0pqp-1 izuwCZ"><p class="logo"><a href="/">Cisne.dev blog</a></p><div class="Navigation__BrightnessContainer-sc-1yk0pqp-2 TctaC"><div class="Navigation__BrightnessSpinner-sc-1yk0pqp-3 sLeDt"><button title="Mudar para modo diurno" aria-label="Mudar para modo diurno" class="Navigation__ClearButton-sc-1yk0pqp-4 Navigation__BrightnessIcon-sc-1yk0pqp-5 frsARl">🌙</button><button title="Mudar para modo noturno" aria-label="Mudar para modo noturno" class="Navigation__ClearButton-sc-1yk0pqp-4 Navigation__BrightnessIcon-sc-1yk0pqp-5 frsARl">☀️</button></div></div></div></nav><main><div class="ui__Fit-prwz6b-0 CfxHf"><div><div style="width:0%;opacity:0" class="post__ScrollTrackerContainer-gh0jqu-0 jjKdZc"></div><article class="Poststyles__Container-sc-12qb97v-4 kyWzPB"><h1 class="Poststyles__Title-sc-12qb97v-5 hhBwVH"><a href="/componentes-com-estado-em-typescript-estilo-clojure/">Componentes com estado em Type­Script, estilo Clojure</a></h1><p class="Poststyles__Meta-sc-12qb97v-6 fonWHZ">Publicado em <!-- -->4 jul 2020<!-- -->. Uns <!-- -->5<!-- --> minutos de leitura.</p><div class="Poststyles__Content-sc-12qb97v-7 jhgzPU content"><p>Uma das ideias da programação funcional é o uso de funções puras para definir a lógica da aplicação que você estiver fazendo. Isso traz várias vantagens, como a possibilidade de trabalhar com estruturas de dados imutáveis, o que diminui ou elimina uma classe de problemas de concorência.</p><p>Isso é muito bonito, e eu recomendo essa abordagem, mas em algum momento você (tomara) vai precisar <strong>causar efeitos colaterais no universo</strong>. Seja ler ou escrever num banco de dados, interagir com um servidor ou cliente HTTP, com o sistema de arquivos, e por aí vai. E, nessa hora, separar estes efeitos colaterais ajuda muito a não misturar, sem querer, com a lógica que deveria ser pura.</p><span><!-- summary-break --></span><p>Uma biblioteca em Clojure pequena mas bem útil para isso é a <a href="https://github.com/stuartsierra/component">Component, de Stuart Sierra</a>. Ela define uma interface para criar <strong>componentes</strong> que têm estado, e especificar quais as <strong>dependências</strong> entre esses componentes. O Nubank, por exemplo, <a href="https://github.com/nubank/basic-microservice-example/blob/master/src/basic_microservice_example/components.clj">usa essa biblioteca no template de serviços em Clojure</a>.</p><p>Eu particularmente curto essa abordagem por deixar clara as dependências entre os componentes e minimizar a quantidade de estado global passado de um lado pro outro: a ideia é não passar o Sistema (a coleção de componentes), mas sim <strong>apenas os componentes que cada parte da aplicação precisa</strong>. </p><p>Recentemente, escrevendo projetos em TypeScript, fiquei pensando em maneiras de organizar componentes com efeito colateral, e o costume de programar Clojure me deixou feliz quando encontrei a <a href="https://github.com/leoiacovini/ts-system-components">ts-system-components</a>, criada por Leo Iacovini. É uma biblioteca bem pequena que define uma interface comum para os componentes iniciarem e pararem, e garante que os componentes são inicializados na ordem certa das dependências entre eles.</p><p>Resolvi experimentar e usar num projeto simples para separar partes que antes estavam mais misturadas no código da primeira versão do gerador deste blog que você está lendo. Ele é gerado a partir de arquivos estáticos, então fez sentido ter um componente de <strong>acesso ao sistema de arquivos</strong>. Dele depende um componente de <strong>gerar HTML a partir de templates</strong> que gera HTML a partir dos templates e posts no sistema de arquivos. Outros componentes como um servidor HTTP para desenvolvimento e um gerador de imagens para posts dependem destes componentes. Como são páginas estáticas, a aplicação não tem um banco de dados e nem roda por muito tempo, mas a declaração de dependências dessa maneira me permitiu ter esses componentes separados e criar pontos de entrada que usam um conjunto diferente de componentes de acordo com a tarefa (gerar o blog ou rodar o servidor de desenvolvimento, por exemplo).</p><p>Um componente é algo que implementa uma interface <code>Component</code> com dois métodos: <code>start</code> e <code>stop</code>. Ambos são assíncronos e a biblioteca vai garantir que os componentes são inicializados por completo na ordem necessária para cada dependência. Se o componente não precisa ser incializado/destruído, esses métodos podem ser vazios. O meu componente de sistema de arquivos, por exemplo, tem essa cara:</p><pre class="refractor language-js"><code class="language-js"><span class="token keyword">class</span> <span class="token class-name">FileSystem</span> <span class="token keyword">implements</span> <span class="token class-name">Component</span> <span class="token punctuation">{</span>
  <span class="token keyword">private</span> readonly roodDir<span class="token operator">:</span> string

  <span class="token function">construct</span><span class="token punctuation">(</span><span class="token parameter">rootDir<span class="token operator">:</span> string</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token keyword">this</span><span class="token punctuation">.</span>rootDir <span class="token operator">=</span> rootDir
  <span class="token punctuation">}</span>

  <span class="token keyword">async</span> <span class="token function">start</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token keyword">if</span><span class="token punctuation">(</span><span class="token operator">!</span><span class="token keyword">await</span> <span class="token function">exists</span><span class="token punctuation">(</span><span class="token keyword">this</span><span class="token punctuation">.</span>rootDir<span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
      <span class="token keyword">throw</span> <span class="token string">&#x27;Cannot initialize FileSystem: root directory does not exist&#x27;</span>
    <span class="token punctuation">}</span>
  <span class="token punctuation">}</span>

  <span class="token keyword">async</span> <span class="token function">stop</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span><span class="token punctuation">}</span>

  <span class="token keyword">async</span> <span class="token function">listDirectory</span><span class="token punctuation">(</span>path<span class="token operator">:</span> string<span class="token punctuation">)</span><span class="token operator">:</span> Promise<span class="token operator">&lt;</span>string<span class="token punctuation">[</span><span class="token punctuation">]</span><span class="token operator">&gt;</span> <span class="token punctuation">{</span>
    <span class="token comment">// implementation</span>
  <span class="token punctuation">}</span>

  <span class="token keyword">async</span> <span class="token function">readFile</span><span class="token punctuation">(</span>path<span class="token operator">:</span> string<span class="token punctuation">)</span><span class="token operator">:</span> Promise<span class="token operator">&lt;</span>string<span class="token operator">&gt;</span> <span class="token punctuation">{</span>
    <span class="token comment">// implementation</span>
  <span class="token punctuation">}</span>

  <span class="token comment">// ...</span>
<span class="token punctuation">}</span></code></pre><p>Esse componente não tem nenhuma dependência em outro, e recebe na criação só um valor estático. O componente de geração a partir dos templates depende do primeiro, e tem uma cara assim:</p><pre class="refractor language-js"><code class="language-js"><span class="token keyword">class</span> <span class="token class-name">Generator</span> <span class="token keyword">implements</span> <span class="token class-name">Component</span> <span class="token punctuation">{</span>
  <span class="token keyword">private</span> readonly fileSystem<span class="token operator">:</span> FileSystem
  <span class="token keyword">private</span> templates<span class="token operator">?</span><span class="token operator">:</span> Templates

  <span class="token function">construct</span><span class="token punctuation">(</span><span class="token parameter">fileSystem<span class="token operator">:</span> FileSystem</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token keyword">this</span><span class="token punctuation">.</span>fileSystem <span class="token operator">=</span> fileSystem
  <span class="token punctuation">}</span>

  <span class="token keyword">async</span> <span class="token function">start</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token keyword">this</span><span class="token punctuation">.</span>templates <span class="token operator">=</span> <span class="token keyword">await</span> <span class="token keyword">this</span><span class="token punctuation">.</span><span class="token function">buildTemplates</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
  <span class="token punctuation">}</span>

  <span class="token keyword">async</span> <span class="token function">stop</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span><span class="token punctuation">}</span>

  <span class="token keyword">async</span> <span class="token function">buildTemplates</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token operator">:</span> Promise<span class="token operator">&lt;</span>Templates<span class="token operator">&gt;</span> <span class="token punctuation">{</span>
    <span class="token comment">// implementation</span>
  <span class="token punctuation">}</span>

  <span class="token keyword">async</span> <span class="token function">generatePostPage</span><span class="token punctuation">(</span>post<span class="token operator">:</span> Post<span class="token punctuation">)</span><span class="token operator">:</span> Promise<span class="token operator">&lt;</span>string<span class="token operator">&gt;</span> <span class="token punctuation">{</span>
    <span class="token comment">// implementation</span>
  <span class="token punctuation">}</span>

  <span class="token comment">// ...</span>
<span class="token punctuation">}</span></code></pre><p>Finalmente, a conexão desses componentes é feita num sistema, que é uma classe que extende a classe <code>System</code>. Ela tem esses decoradores que servem para declarar as dependências entre os componentes. </p><pre class="refractor language-js"><code class="language-js"><span class="token keyword">class</span> <span class="token class-name">BaseSystem</span> <span class="token keyword">extends</span> <span class="token class-name">System</span> <span class="token punctuation">{</span>
  @BaseSystem<span class="token punctuation">.</span><span class="token function">Using</span><span class="token punctuation">(</span><span class="token punctuation">[</span><span class="token punctuation">]</span><span class="token punctuation">,</span> <span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">=&gt;</span> <span class="token keyword">new</span> <span class="token class-name">FileSystem</span><span class="token punctuation">(</span>process<span class="token punctuation">.</span><span class="token function">cwd</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">)</span>
  fileSystem<span class="token operator">!</span><span class="token operator">:</span> FileSystem

  @BaseSystem<span class="token punctuation">.</span><span class="token function">Using</span><span class="token punctuation">(</span><span class="token punctuation">[</span><span class="token string">&#x27;fileSystem&#x27;</span><span class="token punctuation">]</span><span class="token punctuation">,</span> <span class="token punctuation">(</span><span class="token parameter"><span class="token punctuation">{</span> fileSystem <span class="token punctuation">}</span></span><span class="token punctuation">)</span> <span class="token operator">=&gt;</span> <span class="token keyword">new</span> <span class="token class-name">Generator</span><span class="token punctuation">(</span>fileSystem<span class="token punctuation">)</span><span class="token punctuation">)</span>
  generator<span class="token operator">!</span><span class="token operator">:</span> Generator
<span class="token punctuation">}</span></code></pre><p>Ao inicializar uma instância de um sistema, temos garantido que os componentes estão prontos para serem usados. Por exemplo, uma página de um post pode ser gerada de uma maneira semelhante a essa:</p><pre class="refractor language-js"><code class="language-js"><span class="token keyword">const</span> system <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">BaseSystem</span><span class="token punctuation">(</span><span class="token punctuation">)</span>

<span class="token keyword">await</span> system<span class="token punctuation">.</span><span class="token function">start</span><span class="token punctuation">(</span><span class="token punctuation">)</span>

<span class="token keyword">const</span> post <span class="token operator">=</span> <span class="token punctuation">{</span>
  title<span class="token operator">:</span> <span class="token string">&#x27;A post&#x27;</span><span class="token punctuation">,</span>
  date<span class="token operator">:</span> <span class="token keyword">new</span> <span class="token class-name">Date</span><span class="token punctuation">(</span><span class="token number">2020</span><span class="token punctuation">,</span> <span class="token number">1</span><span class="token punctuation">,</span> <span class="token number">2</span><span class="token punctuation">)</span><span class="token punctuation">,</span>
  <span class="token comment">// ...</span>
<span class="token punctuation">}</span>

console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span><span class="token keyword">await</span> system<span class="token punctuation">.</span>generator<span class="token punctuation">.</span><span class="token function">generatePostPage</span><span class="token punctuation">(</span>post<span class="token punctuation">)</span><span class="token punctuation">)</span></code></pre><p>Os outros componentes, o servidor de desenvolvimento e o gerador de imagens, podem ser adicionados ao sistema com dependência no componente de geração dos templates. O legal é que, para aplicações diferentes, podemos construir um sistema diferente apenas com o que é necessário. Por exemplo, enquanto estou com o servidor de desenvolvimento aberto, eu não vou ficar gerando das imagens dos posts, então eu posso ter um <code>System</code> sem este último componente e ele nem vai ser inicializado. </p><p>Num projeto pequeno, como este, essa resolução ordenada e injeção de dependências podem parecer um excesso. E talvez seja, mesmo. Mas me ajudou a pensar quais efeitos colaterais estavam misturados em pedaços de código e como eu poderia isolá-los. A distinção entre lógica e efeitos colaterais ficou mais bem definida, mas ainda dá para melhorar.</p><p>Além disso, essa implementação abriu as portas para a criação de diferentes versões dos mesmos componentes (como, por exemplo, um &quot;sistema de arquivos&quot; falso que guarda tudo em memória, usando estruturas de dados de JS), que podem ser usadas em testes de integração sem se preocupar em, na hora do teste, ter que fazer <em>mocks</em> de cada efeito colateral. É uma ideia que uso bastante nos projetos em Clojure que trabalho e que vou experimentar por aqui também!</p></div><hr/><div class="Poststyles__AfterPost-sc-12qb97v-0 tuaWG"><p class="Poststyles__AfterPostChild-sc-12qb97v-1 gkeqUt">Gostou? <a href="https://twitter.com/intent/tweet?text=%22Componentes%20com%20estado%20em%20Type%C2%ADScript%2C%20estilo%20Clojure%22%20por%20%40Cisneiros%0A%0Ahttps%3A%2F%2Fblog.cisne.dev%2Fcomponentes-com-estado-em-typescript-estilo-clojure" target="_blank" rel="noopener noreferrer">Que tal compartilhar?</a></p><p class="Poststyles__AfterPostChild-sc-12qb97v-1 Poststyles__Tags-sc-12qb97v-2 fAvgXR">Tags: <span class="Poststyles__Tag-sc-12qb97v-3 kSZCZX"><a href="/tag/typescript">typescript</a></span></p></div></article></div></div></main><footer class="Footer__Container-b3q04c-0 gdHjSq"><div class="ui__Fit-prwz6b-0 Footer__FooterFit-b3q04c-1 layJcq"><p>© <a href="https://cisne.dev">Alexandre Cisneiros</a></p><p><a rel="license" href="http://creativecommons.org/licenses/by-sa/4.0/">CC-BY-SA 4.0</a></p></div></footer></div><script type="text/javascript">window.__routeInfo = JSON.parse("{\"template\":\"__react_static_root__/src/containers/post\",\"sharedHashesByProp\":{},\"data\":{\"postData\":{\"title\":\"Componentes com estado em Type\u00ADScript, estilo Clojure\",\"date\":\"2020-07-04T00:00:00-03:00\",\"slug\":\"componentes-com-estado-em-typescript-estilo-clojure\",\"tags\":[\"typescript\"],\"filePath\":\"2020-07-04-componentes-com-estado-em-typescript-estilo-clojure.md\",\"content\":\"Uma das ideias da programa\u00E7\u00E3o funcional \u00E9 o uso de fun\u00E7\u00F5es puras para definir a l\u00F3gica da aplica\u00E7\u00E3o que voc\u00EA estiver fazendo. Isso traz v\u00E1rias vantagens, como a possibilidade de trabalhar com estruturas de dados imut\u00E1veis, o que diminui ou elimina uma classe de problemas de concor\u00EAncia.\\n\\nIsso \u00E9 muito bonito, e eu recomendo essa abordagem, mas em algum momento voc\u00EA (tomara) vai precisar **causar efeitos colaterais no universo**. Seja ler ou escrever num banco de dados, interagir com um servidor ou cliente HTTP, com o sistema de arquivos, e por a\u00ED vai. E, nessa hora, separar estes efeitos colaterais ajuda muito a n\u00E3o misturar, sem querer, com a l\u00F3gica que deveria ser pura.\\n\\n\u003C!-- summary-break -->\\n\\nUma biblioteca em Clojure pequena mas bem \u00FAtil para isso \u00E9 a [Component, de Stuart Sierra](https://github.com/stuartsierra/component). Ela define uma interface para criar **componentes** que t\u00EAm estado, e especificar quais as **depend\u00EAncias** entre esses componentes. O Nubank, por exemplo, [usa essa biblioteca no template de servi\u00E7os em Clojure](https://github.com/nubank/basic-microservice-example/blob/master/src/basic_microservice_example/components.clj).\\n\\nEu particularmente curto essa abordagem por deixar clara as depend\u00EAncias entre os componentes e minimizar a quantidade de estado global passado de um lado pro outro: a ideia \u00E9 n\u00E3o passar o Sistema (a cole\u00E7\u00E3o de componentes), mas sim **apenas os componentes que cada parte da aplica\u00E7\u00E3o precisa**. \\n\\nRecentemente, escrevendo projetos em TypeScript, fiquei pensando em maneiras de organizar componentes com efeito colateral, e o costume de programar Clojure me deixou feliz quando encontrei a [ts-system-components](https://github.com/leoiacovini/ts-system-components), criada por Leo Iacovini. \u00C9 uma biblioteca bem pequena que define uma interface comum para os componentes iniciarem e pararem, e garante que os componentes s\u00E3o inicializados na ordem certa das depend\u00EAncias entre eles.\\n\\nResolvi experimentar e usar num projeto simples para separar partes que antes estavam mais misturadas no c\u00F3digo da primeira vers\u00E3o do gerador deste blog que voc\u00EA est\u00E1 lendo. Ele \u00E9 gerado a partir de arquivos est\u00E1ticos, ent\u00E3o fez sentido ter um componente de **acesso ao sistema de arquivos**. Dele depende um componente de **gerar HTML a partir de templates** que gera HTML a partir dos templates e posts no sistema de arquivos. Outros componentes como um servidor HTTP para desenvolvimento e um gerador de imagens para posts dependem destes componentes. Como s\u00E3o p\u00E1ginas est\u00E1ticas, a aplica\u00E7\u00E3o n\u00E3o tem um banco de dados e nem roda por muito tempo, mas a declara\u00E7\u00E3o de depend\u00EAncias dessa maneira me permitiu ter esses componentes separados e criar pontos de entrada que usam um conjunto diferente de componentes de acordo com a tarefa (gerar o blog ou rodar o servidor de desenvolvimento, por exemplo).\\n\\nUm componente \u00E9 algo que implementa uma interface `Component` com dois m\u00E9todos: `start` e `stop`. Ambos s\u00E3o ass\u00EDncronos e a biblioteca vai garantir que os componentes s\u00E3o inicializados por completo na ordem necess\u00E1ria para cada depend\u00EAncia. Se o componente n\u00E3o precisa ser incializado/destru\u00EDdo, esses m\u00E9todos podem ser vazios. O meu componente de sistema de arquivos, por exemplo, tem essa cara:\\n\\n```ts\\nclass FileSystem implements Component {\\n  private readonly roodDir: string\\n\\n  construct(rootDir: string) {\\n    this.rootDir = rootDir\\n  }\\n\\n  async start() {\\n    if(!await exists(this.rootDir)) {\\n      throw 'Cannot initialize FileSystem: root directory does not exist'\\n    }\\n  }\\n\\n  async stop() {}\\n\\n  async listDirectory(path: string): Promise<string[]> {\\n    // implementation\\n  }\\n\\n  async readFile(path: string): Promise<string> {\\n    // implementation\\n  }\\n\\n  // ...\\n}\\n```\\n\\nEsse componente n\u00E3o tem nenhuma depend\u00EAncia em outro, e recebe na cria\u00E7\u00E3o s\u00F3 um valor est\u00E1tico. O componente de gera\u00E7\u00E3o a partir dos templates depende do primeiro, e tem uma cara assim:\\n\\n```ts\\nclass Generator implements Component {\\n  private readonly fileSystem: FileSystem\\n  private templates?: Templates\\n\\n  construct(fileSystem: FileSystem) {\\n    this.fileSystem = fileSystem\\n  }\\n\\n  async start() {\\n    this.templates = await this.buildTemplates()\\n  }\\n\\n  async stop() {}\\n\\n  async buildTemplates(): Promise<Templates> {\\n    // implementation\\n  }\\n\\n  async generatePostPage(post: Post): Promise<string> {\\n    // implementation\\n  }\\n\\n  // ...\\n}\\n```\\n\\nFinalmente, a conex\u00E3o desses componentes \u00E9 feita num sistema, que \u00E9 uma classe que extende a classe `System`. Ela tem esses decoradores que servem para declarar as depend\u00EAncias entre os componentes. \\n\\n```ts\\nclass BaseSystem extends System {\\n  @BaseSystem.Using([], () => new FileSystem(process.cwd()))\\n  fileSystem!: FileSystem\\n\\n  @BaseSystem.Using(['fileSystem'], ({ fileSystem }) => new Generator(fileSystem))\\n  generator!: Generator\\n}\\n```\\n\\nAo inicializar uma inst\u00E2ncia de um sistema, temos garantido que os componentes est\u00E3o prontos para serem usados. Por exemplo, uma p\u00E1gina de um post pode ser gerada de uma maneira semelhante a essa:\\n\\n```ts\\nconst system = new BaseSystem()\\n\\nawait system.start()\\n\\nconst post = {\\n  title: 'A post',\\n  date: new Date(2020, 1, 2),\\n  // ...\\n}\\n\\nconsole.log(await system.generator.generatePostPage(post))\\n```\\n\\nOs outros componentes, o servidor de desenvolvimento e o gerador de imagens, podem ser adicionados ao sistema com depend\u00EAncia no componente de gera\u00E7\u00E3o dos templates. O legal \u00E9 que, para aplica\u00E7\u00F5es diferentes, podemos construir um sistema diferente apenas com o que \u00E9 necess\u00E1rio. Por exemplo, enquanto estou com o servidor de desenvolvimento aberto, eu n\u00E3o vou ficar gerando das imagens dos posts, ent\u00E3o eu posso ter um `System` sem este \u00FAltimo componente e ele nem vai ser inicializado. \\n\\nNum projeto pequeno, como este, essa resolu\u00E7\u00E3o ordenada e inje\u00E7\u00E3o de depend\u00EAncias podem parecer um excesso. E talvez seja, mesmo. Mas me ajudou a pensar quais efeitos colaterais estavam misturados em peda\u00E7os de c\u00F3digo e como eu poderia isol\u00E1-los. A distin\u00E7\u00E3o entre l\u00F3gica e efeitos colaterais ficou mais bem definida, mas ainda d\u00E1 para melhorar.\\n\\nAl\u00E9m disso, essa implementa\u00E7\u00E3o abriu as portas para a cria\u00E7\u00E3o de diferentes vers\u00F5es dos mesmos componentes (como, por exemplo, um \\\"sistema de arquivos\\\" falso que guarda tudo em mem\u00F3ria, usando estruturas de dados de JS), que podem ser usadas em testes de integra\u00E7\u00E3o sem se preocupar em, na hora do teste, ter que fazer _mocks_ de cada efeito colateral. \u00C9 uma ideia que uso bastante nos projetos em Clojure que trabalho e que vou experimentar por aqui tamb\u00E9m!\\n\",\"readingTime\":5,\"summary\":\"Uma das ideias da programa\u00E7\u00E3o funcional \u00E9 o uso de fun\u00E7\u00F5es puras para definir a l\u00F3gica da aplica\u00E7\u00E3o que voc\u00EA estiver fazendo. Isso traz v\u00E1rias vantagens, como a possibilidade de trabalhar com estruturas de dados imut\u00E1veis, o que diminui ou elimina uma classe de problemas de concor\u00EAncia.\\n\\nIsso \u00E9 muito bonito, e eu recomendo essa abordagem, mas em algum momento voc\u00EA (tomara) vai precisar **causar efeitos colaterais no universo**. Seja ler ou escrever num banco de dados, interagir com um servidor ou cliente HTTP, com o sistema de arquivos, e por a\u00ED vai. E, nessa hora, separar estes efeitos colaterais ajuda muito a n\u00E3o misturar, sem querer, com a l\u00F3gica que deveria ser pura.\\n\\n\"}},\"path\":\"componentes-com-estado-em-typescript-estilo-clojure\",\"sharedData\":{},\"siteData\":{}}");</script><script defer="" type="text/javascript" src="/templates/vendors~__react_static_root__/src/containers/post~__react_static_root__/src/containers/postList.207edc50.js"></script><script defer="" type="text/javascript" src="/templates/__react_static_root__/src/containers/post~__react_static_root__/src/containers/postList.a04ea84b.js"></script><script defer="" type="text/javascript" src="/templates/__react_static_root__/src/containers/post.d8dd52db.js"></script><script defer="" type="text/javascript" src="/templates/vendors~main.272ae1d1.js"></script><script defer="" type="text/javascript" src="/main.f19d4c14.js"></script></body></html>